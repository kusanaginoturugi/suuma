<% content_for :title, t(".title") %>

<div class="page-shell">
  <div class="hero">
    <p class="eyebrow">DOUBLE-ENTRY</p>
    <h1><%= t(".heading") %></h1>
    <p class="sub"><%= t(".sub") %></p>
    <div class="pill-row">
      <span class="pill"><%= t(".pill_draft") %></span>
      <span class="pill pill--accent"><%= t(".pill_balance") %></span>
      <%= link_to t("bank_imports.shared.import_button"), new_bank_import_path, class: "pill pill--ghost" %>
    </div>
  </div>

  <% if flash[:notice] %>
    <div class="flash flash--notice"><%= flash[:notice] %></div>
  <% end %>
  <% if flash[:alert] %>
    <div class="flash flash--alert"><%= flash[:alert] %></div>
  <% end %>

  <%= form_with model: @voucher, class: "voucher-form", data: { controller: "voucher-form" } do |f| %>
    <section class="card card--stacked">
      <div class="card__header">
        <div>
          <p class="eyebrow"><%= t(".header_tag") %></p>
          <h2><%= t(".header_title") %></h2>
        </div>
      </div>
      <div class="field-grid">
        <div class="field">
          <%= f.label :recorded_on, t(".recorded_on") %>
          <%= f.date_field :recorded_on, value: @voucher[:recorded_on], required: true %>
        </div>
        <div class="field">
          <%= f.label :voucher_number, t(".voucher_number") %>
          <%= f.text_field :voucher_number, value: @voucher[:voucher_number], required: true, placeholder: t(".voucher_number_placeholder") %>
        </div>
        <div class="field field--full">
          <%= f.label :description, t(".description") %>
          <%= f.text_field :description, value: @voucher[:description], placeholder: t(".description_placeholder") %>
        </div>
      </div>
    </section>

    <section class="card card--stacked">
      <div class="card__header">
        <div>
          <p class="eyebrow"><%= t(".detail_tag") %></p>
          <h2><%= t(".detail_title") %></h2>
          <p class="sub"><%= t(".detail_sub") %></p>
        </div>
        <div class="card__actions">
          <button type="button" class="btn btn--ghost" data-action="click->voucher-form#addRow"><%= t(".add_row") %></button>
        </div>
      </div>

      <div class="entry-head">
        <span><%= t(".account_code") %></span>
        <span><%= t(".debit_amount") %></span>
        <span><%= t(".credit_amount") %></span>
        <span><%= t(".note") %></span>
        <span></span>
      </div>

      <div class="entry-list" data-voucher-form-target="rows" data-next-index="<%= @voucher.voucher_lines.size %>">
        <% @voucher.voucher_lines.each do |line| %>
          <%= f.fields_for :voucher_lines, line do |lf| %>
            <div class="entry-row" data-voucher-form-target="row">
              <%= lf.text_field :account_code, placeholder: t(".account_code_placeholder"), list: "account-codes" %>
              <%= lf.number_field :debit_amount, step: 0.01, min: 0, data: { action: "input->voucher-form#recalculate" }, inputmode: "decimal" %>
              <%= lf.number_field :credit_amount, step: 0.01, min: 0, data: { action: "input->voucher-form#recalculate" }, inputmode: "decimal" %>
              <%= lf.text_field :note, placeholder: t(".note_placeholder") %>
              <button type="button" class="icon-button" aria-label="行を削除" data-action="click->voucher-form#removeRow">✕</button>
            </div>
          <% end %>
        <% end %>
      </div>

      <template data-voucher-form-target="rowTemplate">
        <div class="entry-row" data-voucher-form-target="row">
          <input type="text" name="voucher[voucher_lines_attributes][__INDEX__][account_code]" placeholder="<%= t('.account_code') %>" list="account-codes">
          <input type="number" step="0.01" min="0" name="voucher[voucher_lines_attributes][__INDEX__][debit_amount]" data-action="input->voucher-form#recalculate" inputmode="decimal">
          <input type="number" step="0.01" min="0" name="voucher[voucher_lines_attributes][__INDEX__][credit_amount]" data-action="input->voucher-form#recalculate" inputmode="decimal">
          <input type="text" name="voucher[voucher_lines_attributes][__INDEX__][note]" placeholder="<%= t('.note_placeholder') %>">
          <button type="button" class="icon-button" aria-label="行を削除" data-action="click->voucher-form#removeRow">✕</button>
        </div>
      </template>

      <datalist id="account-codes">
        <% @accounts.each do |account| %>
          <option value="<%= account.code %>"><%= "#{account.code} #{account.name}" %></option>
        <% end %>
      </datalist>

      <div class="totals">
        <div>
          <p class="eyebrow"><%= t(".totals.debit") %></p>
          <p class="totals__value" data-voucher-form-target="totalDebit"><%= number_with_delimiter(@voucher.total_debit) %></p>
        </div>
        <div>
          <p class="eyebrow"><%= t(".totals.credit") %></p>
          <p class="totals__value" data-voucher-form-target="totalCredit"><%= number_with_delimiter(@voucher.total_credit) %></p>
        </div>
        <div class="balance">
          <p class="eyebrow"><%= t(".totals.diff") %></p>
          <p class="totals__value totals__value--small" data-voucher-form-target="difference"><%= number_with_delimiter(@voucher.balance_difference) %></p>
          <span class="badge <%= @voucher.balance_difference.zero? ? "badge--ok" : "badge--warn" %>" data-voucher-form-target="balanceBadge"
            data-badge-ok-text="<%= t('.totals.ok') %>" data-badge-warn-text="<%= t('.totals.warn') %>">
            <%= @voucher.balance_difference.zero? ? t(".totals.ok") : t(".totals.warn") %>
          </span>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn--primary"><%= t(".submit") %></button>
        <p class="sub"><%= t(".submit_note") %></p>
      </div>
    </section>
  <% end %>
</div>
