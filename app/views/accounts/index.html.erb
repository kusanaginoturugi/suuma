<% content_for :title, t("accounts.index.title") %>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <p class="text-uppercase text-muted mb-1 small">ACCOUNTS</p>
      <h1 class="h3 mb-1"><%= t("accounts.index.heading") %></h1>
      <p class="text-muted mb-2"><%= t("accounts.index.sub") %></p>
      <div class="d-flex flex-wrap gap-2">
        <span class="badge bg-secondary-subtle text-secondary">
          <%= t("accounts.index.count", count: @accounts.size) %>
        </span>
      </div>
    </div>
    <div class="d-flex gap-2">
      <%= link_to t("accounts.index.new_button"), new_account_path, class: "btn btn-primary" %>
    </div>
  </div>

  <% if flash[:notice] %>
    <div class="alert alert-success"><%= flash[:notice] %></div>
  <% end %>
  <% if flash[:alert] %>
    <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-striped align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 10%;"><%= t("accounts.index.th.code") %></th>
            <th style="width: 25%;"><%= t("accounts.index.th.name") %></th>
            <th style="width: 25%;"><%= t("accounts.index.th.details") %></th>
            <th style="width: 10%;"><%= t("accounts.index.th.category") %></th>
            <th style="width: 10%;"><%= t("accounts.index.th.parent") %></th>
            <th style="width: 20%;" class="text-end"><%= t("accounts.index.th.actions") %></th>
          </tr>
        </thead>
        <tbody>
          <% groups = @accounts.group_by(&:category) %>
          <% Account::CATEGORIES.each do |cat| %>
            <% next unless groups[cat].present? %>
            <tr class="table-secondary">
              <td colspan="7" class="fw-bold"><%= t("accounts.categories.#{cat}") %></td>
            </tr>
            <% children = groups[cat].group_by(&:parent_code) %>
            <% render_nodes = lambda do |parent_code, level|
                 (children[parent_code] || []).each do |acc|
            %>
              <%= form_with model: acc, url: account_path(acc), method: :patch, data: { turbo: false }, class: "m-0 p-0 row-form" do |f| %>
                <tr class="cat-<%= cat %>">
                  <td>
                    <%= f.text_field :code, class: "form-control form-control-sm", required: true %>
                  </td>
                  <td>
                    <%= f.text_field :name, class: "form-control form-control-sm", required: true, style: "padding-left: #{level * 16}px;" %>
                  </td>
                  <td>
                    <%= f.text_field :details, class: "form-control form-control-sm" %>
                  </td>
                  <td>
                    <%= f.select :category, Account::CATEGORIES.map { |c| [t("accounts.categories.#{c}"), c] }, {}, class: "form-select form-select-sm", required: true %>
                  </td>
                  <td>
                    <%= f.select :parent_code,
                      options_for_select([[t("accounts.form.no_parent"), nil]] + @accounts.reject { |a| a.code == acc.code }.map { |a| ["#{a.code} #{a.name}", a.code] }, acc.parent_code),
                      {}, class: "form-select form-select-sm" %>
                  </td>
                  <td class="text-end">
                    <div class="d-flex justify-content-end gap-2">
                      <%= link_to t("accounts.index.entries"), entries_account_path(acc), class: "btn btn-outline-secondary btn-sm" %>
                      <button type="submit" class="btn btn-sm" style="background:#0d6efd; color:#fff; border-color:#0d6efd;"><%= t("accounts.index.save") %></button>
                      <%= link_to t("accounts.index.delete"), account_path(acc),
                        data: { turbo_method: :delete, turbo_confirm: t("accounts.index.delete_confirm", name: acc.name) },
                        class: "btn btn-sm", style: "background:#dc3545; color:#fff; border-color:#dc3545;" %>
                    </div>
                  </td>
                </tr>
              <% end %>
              <% render_nodes.call(acc.code, level + 1) %>
            <%   end
               end %>
            <% render_nodes.call(nil, 0) %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
