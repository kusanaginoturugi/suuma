<% content_for :title, t("vouchers.quick.title") %>

<div class="container py-4">
  <div class="mb-3">
    <p class="text-uppercase text-muted mb-1 small"><%= t("vouchers.quick.eyebrow") %></p>
    <h1 class="h3 mb-1"><%= t("vouchers.quick.heading") %></h1>
    <p class="text-muted mb-2"><%= t("vouchers.quick.sub") %></p>
  </div>

  <% if flash[:alert] %>
    <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>
  <% if flash[:notice] %>
    <div class="alert alert-success"><%= flash[:notice] %></div>
  <% end %>

  <div class="card shadow-sm">
    <div class="card-body">
      <%= form_with model: @form, scope: :quick_voucher, url: quick_vouchers_path, local: true, data: { controller: "quick-voucher" } do |f| %>
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <%= f.label :recorded_on, t("vouchers.quick.recorded_on"), class: "form-label" %>
            <%= f.date_field :recorded_on, class: "form-control", required: true, data: { quick_voucher_target: "recordedOn" } %>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0" data-controller="account-lookup" data-account-lookup-accounts-map-value="<%= @accounts_map.to_json %>">
            <thead class="table-light">
              <tr>
                <th style="width: 18%;"><%= t("vouchers.quick.description") %></th>
                <th style="width: 20%;"><%= t("vouchers.quick.account_code") %></th>
                <th style="width: 20%;"><%= t("vouchers.quick.counter_account_code") %></th>
                <th style="width: 16%;" class="text-end"><%= t("vouchers.quick.amount") %></th>
                <th style="width: 20%;"><%= t("vouchers.quick.direction") %></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <%= f.text_field :description_withdrawal, class: "form-control", placeholder: t("vouchers.quick.description_placeholder") %>
                </td>
                <td>
                  <div class="input-group">
                    <%= f.text_field :account_code_withdrawal,
                      class: "form-control",
                      placeholder: t("vouchers.quick.account_code_placeholder"),
                      list: "quick-account-codes",
                      data: { action: "input->account-lookup#update focus->account-lookup#suggest", account_lookup_target: "code" } %>
                    <span class="input-group-text" data-account-lookup-target="name"></span>
                  </div>
                </td>
                <td>
                  <div class="input-group">
                    <%= f.text_field :counter_account_code_withdrawal,
                      class: "form-control",
                      placeholder: t("vouchers.quick.counter_account_code_placeholder"),
                      list: "quick-account-codes",
                      data: { action: "input->account-lookup#update focus->account-lookup#suggest", account_lookup_target: "code" } %>
                    <span class="input-group-text" data-account-lookup-target="name"></span>
                  </div>
                </td>
                <td>
                  <%= f.number_field :amount_withdrawal,
                    class: "form-control text-end",
                    min: 1,
                    step: 1,
                    data: { action: "keydown.enter->quick-voucher#submitWithdrawal", quick_voucher_target: "amountWithdrawal" } %>
                </td>
                <td>
                  <button type="submit" name="quick_voucher[direction]" value="withdrawal" class="btn btn-primary btn-sm w-100" data-quick-voucher-target="withdrawalButton">
                    <%= t("vouchers.quick.withdrawal_button") %>
                  </button>
                </td>
              </tr>
              <tr>
                <td>
                  <%= f.text_field :description_deposit, class: "form-control", placeholder: t("vouchers.quick.description_placeholder") %>
                </td>
                <td>
                  <div class="input-group">
                    <%= f.text_field :account_code_deposit,
                      class: "form-control",
                      placeholder: t("vouchers.quick.account_code_placeholder"),
                      list: "quick-account-codes",
                      data: { action: "input->account-lookup#update focus->account-lookup#suggest", account_lookup_target: "code" } %>
                    <span class="input-group-text" data-account-lookup-target="name"></span>
                  </div>
                </td>
                <td>
                  <div class="input-group">
                    <%= f.text_field :counter_account_code_deposit,
                      class: "form-control",
                      placeholder: t("vouchers.quick.counter_account_code_placeholder"),
                      list: "quick-account-codes",
                      data: { action: "input->account-lookup#update focus->account-lookup#suggest", account_lookup_target: "code" } %>
                    <span class="input-group-text" data-account-lookup-target="name"></span>
                  </div>
                </td>
                <td>
                  <%= f.number_field :amount_deposit,
                    class: "form-control text-end",
                    min: 1,
                    step: 1,
                    data: { action: "keydown.enter->quick-voucher#submitDeposit", quick_voucher_target: "amountDeposit" } %>
                </td>
                <td>
                  <button type="submit" name="quick_voucher[direction]" value="deposit" class="btn btn-success btn-sm w-100" data-quick-voucher-target="depositButton">
                    <%= t("vouchers.quick.deposit_button") %>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <datalist id="quick-account-codes">
          <% @accounts.each do |account| %>
            <option value="<%= account.code %>"><%= "#{account.code} #{account.name}" %></option>
          <% end %>
        </datalist>
      <% end %>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <h2 class="h6 mb-3"><%= t("vouchers.quick.history_title") %></h2>
      <% if @recent_vouchers.empty? %>
        <p class="text-muted mb-0"><%= t("vouchers.quick.history_empty") %></p>
      <% else %>
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th><%= t("vouchers.quick.history.th.recorded_on") %></th>
                <th><%= t("vouchers.quick.history.th.description") %></th>
                <th><%= t("vouchers.quick.history.th.debit_accounts") %></th>
                <th><%= t("vouchers.quick.history.th.credit_accounts") %></th>
                <th class="text-end"><%= t("vouchers.quick.history.th.amount") %></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% @recent_vouchers.each do |voucher| %>
                <% debit_lines = voucher.voucher_lines.select { |line| line.debit_amount.to_d.positive? } %>
                <% credit_lines = voucher.voucher_lines.select { |line| line.credit_amount.to_d.positive? } %>
                <% debit_names = debit_lines.map { |line| "#{line.account_code} #{(@accounts_map[line.account_code] || line.account.presence || '')}".strip }.uniq %>
                <% credit_names = credit_lines.map { |line| "#{line.account_code} #{(@accounts_map[line.account_code] || line.account.presence || '')}".strip }.uniq %>
                <% amount = debit_lines.sum { |line| line.debit_amount.to_d } %>
                <tr>
                  <td><%= voucher.recorded_on&.strftime("%Y-%m-%d") %></td>
                  <td><%= voucher.description.presence || "—" %></td>
                  <td><%= debit_names.presence&.join(" / ") || "—" %></td>
                  <td><%= credit_names.presence&.join(" / ") || "—" %></td>
                  <td class="text-end"><%= number_with_delimiter(amount.to_i) %></td>
                  <td class="text-end">
                    <%= link_to t("vouchers.quick.history.edit"), edit_voucher_path(voucher), class: "btn btn-outline-secondary btn-sm" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
</div>
