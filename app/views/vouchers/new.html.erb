<% content_for :title, "振替伝票入力 | Summa" %>

<div class="page-shell">
  <div class="hero">
    <p class="eyebrow">DOUBLE-ENTRY</p>
    <h1>振替伝票入力</h1>
    <p class="sub">複式簿記の仕訳をまとめて入力し、その場で借方・貸方のバランスを確認できます。</p>
    <div class="pill-row">
      <span class="pill">ドラフト</span>
      <span class="pill pill--accent">バランスチェック付き</span>
      <button type="button" class="pill pill--ghost" data-action="click->theme-toggle#toggle" data-theme-toggle-target="button">
        ライトモードに切替
      </button>
    </div>
  </div>

  <% if flash[:notice] %>
    <div class="flash flash--notice"><%= flash[:notice] %></div>
  <% end %>
  <% if flash[:alert] %>
    <div class="flash flash--alert"><%= flash[:alert] %></div>
  <% end %>

  <%= form_with model: @voucher, class: "voucher-form", data: { controller: "voucher-form" } do |f| %>
    <section class="card card--stacked">
      <div class="card__header">
        <div>
          <p class="eyebrow">HEADER</p>
          <h2>起票情報</h2>
        </div>
      </div>
      <div class="field-grid">
        <div class="field">
          <%= f.label :recorded_on, "起票日" %>
          <%= f.date_field :recorded_on, value: @voucher[:recorded_on], required: true %>
        </div>
        <div class="field">
          <%= f.label :voucher_number, "伝票番号" %>
          <%= f.text_field :voucher_number, value: @voucher[:voucher_number], required: true, placeholder: "20251208-001" %>
        </div>
        <div class="field field--full">
          <%= f.label :description, "摘要 / メモ" %>
          <%= f.text_field :description, value: @voucher[:description], placeholder: "例）オフィス家賃振替" %>
        </div>
      </div>
    </section>

    <section class="card card--stacked">
      <div class="card__header">
        <div>
          <p class="eyebrow">DETAIL</p>
          <h2>仕訳明細</h2>
          <p class="sub">借方・貸方の行を自由に追加してください。空行は自動で無視されます。</p>
        </div>
        <div class="card__actions">
          <button type="button" class="btn btn--ghost" data-action="click->voucher-form#addRow">+ 行を追加</button>
        </div>
      </div>

      <div class="entry-head">
        <span>科目コード</span>
        <span>借方金額</span>
        <span>貸方金額</span>
        <span>摘要</span>
        <span></span>
      </div>

      <div class="entry-list" data-voucher-form-target="rows" data-next-index="<%= @voucher.voucher_lines.size %>">
        <% @voucher.voucher_lines.each do |line| %>
          <%= f.fields_for :voucher_lines, line do |lf| %>
            <div class="entry-row" data-voucher-form-target="row">
              <%= lf.text_field :account_code, placeholder: "例) 101", list: "account-codes" %>
              <%= lf.number_field :debit_amount, step: 0.01, min: 0, data: { action: "input->voucher-form#recalculate" }, inputmode: "decimal" %>
              <%= lf.number_field :credit_amount, step: 0.01, min: 0, data: { action: "input->voucher-form#recalculate" }, inputmode: "decimal" %>
              <%= lf.text_field :note, placeholder: "補足メモ" %>
              <button type="button" class="icon-button" aria-label="行を削除" data-action="click->voucher-form#removeRow">✕</button>
            </div>
          <% end %>
        <% end %>
      </div>

      <template data-voucher-form-target="rowTemplate">
        <div class="entry-row" data-voucher-form-target="row">
          <input type="text" name="voucher[voucher_lines_attributes][__INDEX__][account_code]" placeholder="科目コード" list="account-codes">
          <input type="number" step="0.01" min="0" name="voucher[voucher_lines_attributes][__INDEX__][debit_amount]" data-action="input->voucher-form#recalculate" inputmode="decimal">
          <input type="number" step="0.01" min="0" name="voucher[voucher_lines_attributes][__INDEX__][credit_amount]" data-action="input->voucher-form#recalculate" inputmode="decimal">
          <input type="text" name="voucher[voucher_lines_attributes][__INDEX__][note]" placeholder="補足メモ">
          <button type="button" class="icon-button" aria-label="行を削除" data-action="click->voucher-form#removeRow">✕</button>
        </div>
      </template>

      <datalist id="account-codes">
        <% @accounts.each do |account| %>
          <option value="<%= account.code %>"><%= "#{account.code} #{account.name}" %></option>
        <% end %>
      </datalist>

      <div class="totals">
        <div>
          <p class="eyebrow">借方合計</p>
          <p class="totals__value" data-voucher-form-target="totalDebit"><%= number_with_delimiter(@voucher.total_debit) %></p>
        </div>
        <div>
          <p class="eyebrow">貸方合計</p>
          <p class="totals__value" data-voucher-form-target="totalCredit"><%= number_with_delimiter(@voucher.total_credit) %></p>
        </div>
        <div class="balance">
          <p class="eyebrow">差分</p>
          <p class="totals__value totals__value--small" data-voucher-form-target="difference"><%= number_with_delimiter(@voucher.balance_difference) %></p>
          <span class="badge <%= @voucher.balance_difference.zero? ? "badge--ok" : "badge--warn" %>" data-voucher-form-target="balanceBadge">
            <%= @voucher.balance_difference.zero? ? "バランスOK" : "調整してください" %>
          </span>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn--primary">保存</button>
        <p class="sub">保存してデータベースに登録します。借貸バランスが合わない場合はエラーになります。</p>
      </div>
    </section>
  <% end %>
</div>
