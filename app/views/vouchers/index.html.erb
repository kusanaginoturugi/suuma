<% content_for :title, t(".title") %>

<div class="page-shell">
  <div class="hero">
    <p class="eyebrow">DOUBLE-ENTRY</p>
    <h1><%= t(".heading") %></h1>
    <p class="sub"><%= t(".sub") %></p>
    <div class="pill-row">
      <span class="pill"><%= t(".saved_count", count: @vouchers.size) %></span>
      <span class="pill"><%= t(".total_debit", amount: number_with_delimiter(@total_debit.to_i)) %></span>
      <span class="pill"><%= t(".total_credit", amount: number_with_delimiter(@total_credit.to_i)) %></span>
      <%= link_to t(".new_button"), new_voucher_path, class: "pill pill--accent" %>
      <%= link_to t("bank_imports.shared.import_button"), new_bank_import_path, class: "pill pill--ghost" %>
    </div>
  </div>

  <% if flash[:notice] %>
    <div class="flash flash--notice"><%= flash[:notice] %></div>
  <% end %>
  <% if flash[:alert] %>
    <div class="flash flash--alert"><%= flash[:alert] %></div>
  <% end %>

  <div class="mb-3">
    <%= form_with url: vouchers_path, method: :get, local: true, class: "d-flex align-items-center gap-2 flex-wrap" do |f| %>
      <span class="text-muted"><%= t(".filter_label") %></span>
      <%= f.select :account_code,
        options_for_select([[t(".filter_all"), ""]] + @accounts.map { |a| ["#{a.code} #{a.name}", a.code] }, @account_code),
        {}, class: "form-select form-select-sm", onchange: "this.form.submit()" %>
      <span class="text-muted"><%= t(".description_filter_label") %></span>
      <%= f.text_field :description, value: @description_filter, class: "form-control form-control-sm", placeholder: t(".description_filter_placeholder") %>
      <noscript>
        <button type="submit" class="btn btn-outline-secondary btn-sm"><%= t(".filter_submit") %></button>
      </noscript>
    <% end %>
  </div>

  <% if @vouchers.empty? %>
    <section class="card">
      <p class="sub"><%= t(".empty") %> <%= link_to t(".new_button"), new_voucher_path %></p>
    </section>
  <% else %>
    <section class="card card--stacked">
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th><%= t(".th.recorded_on") %></th>
              <th><%= t(".th.description") %></th>
              <th><%= t(".th.debit_accounts") %></th>
              <th class="text-end"><%= t(".th.debit") %></th>
              <th><%= t(".th.credit_accounts") %></th>
              <th class="text-end"><%= t(".th.credit") %></th>
              <th class="text-end"><%= t(".th.cumulative_total") %></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% running_total = 0 %>
            <% @vouchers.each do |voucher| %>
              <% primary_code = voucher.voucher_lines.first&.account_code %>
              <% cat_class = "cat-#{Account.find_by(code: primary_code)&.category}" if primary_code.present? %>
              <% debit_names = voucher.voucher_lines.select { |line| line.debit_amount.to_d.positive? }
                                   .map { |line| @accounts_map[line.account_code] || line.account.presence || line.account_code }
                                   .uniq %>
              <% credit_names = voucher.voucher_lines.select { |line| line.credit_amount.to_d.positive? }
                                    .map { |line| @accounts_map[line.account_code] || line.account.presence || line.account_code }
                                    .uniq %>
              <tr class="<%= cat_class %>">
                <td><%= voucher.recorded_on&.strftime("%Y-%m-%d") %></td>
                <td><%= voucher.description.presence || "—" %></td>
                <td><%= debit_names.presence&.join(" / ") || "—" %></td>
                <td class="text-end"><%= number_with_delimiter(voucher.total_debit.to_i) %></td>
                <td><%= credit_names.presence&.join(" / ") || "—" %></td>
                <td class="text-end"><%= number_with_delimiter(voucher.total_credit.to_i) %></td>
                <% running_total += (voucher.total_debit.to_d - voucher.total_credit.to_d) %>
                <td class="text-end"><%= number_with_delimiter(running_total.to_i) %></td>
                <td class="text-end">
                  <%= link_to t("vouchers.index.edit"), edit_voucher_path(voucher), class: "btn btn-outline-secondary btn-sm" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </section>

  <% end %>
</div>
